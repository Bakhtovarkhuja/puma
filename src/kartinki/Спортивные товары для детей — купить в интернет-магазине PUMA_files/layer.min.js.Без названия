define(["uiComponent","jquery","ko","matchSize","Oggetto_LayeredNavigation/js/action/layer","gga.event.refinementSelected",'js/gga/ga4Custom/refinement',"js/lib/theia-sticky-sidebar.min","jquery/jquery.parsequery",],function(Component,$,ko,matchSize,layerAction,refinementSelected,refinementGA4,){"use strict";var $document=$(document),$body=$("body"),$html=$("html");return Component.extend({initialize:function(){this._super();this.settings={filterLink:"[data-filter-link]",toggleButton:"[data-toggle-sidebar]",classSidebarOpen:"_sidebar-open",classNeedFilter:"need-sticky",classExpand:"_expand",classActive:"_active",classSelected:"_selected"};window.$isOpenFilters=false;window.$closeSidebarFiltersMobile=this.closeSidebar.bind(this);this.events();},events:function(){$(document).off("price-filter:change").on("price-filter:change",this.changePrice.bind(this));$document.on("layer:update",this.update.bind(this));$document.on("layer:stickySidebar",this.recalcSticky.bind(this));$document.on("layer:openSidebar",this.openSidebar.bind(this));$document.on("click",this.settings.toggleButton,this.toggleSidebar.bind(this));$body.on("change-state",this.recalcSticky.bind(this));},rendered:function(element){this.$element=$(element);this.initAccordion();this.initSticky();$(this.sidebar).off("click.filter").on("click.filter",this.settings.filterLink,this.filter.bind(this));},filter:function(ev){ev.preventDefault();const $link=$(ev.currentTarget);const link=ev.currentTarget;const filterItemValue=link.dataset.filterValue;const filterItemTextValue=link.dataset.filterTextValue;const filterBlockEl=link.closest('[data-filter-type]');let filterType=filterBlockEl?.dataset?.filterType;$link.toggleClass(this.settings.classSelected);layerAction.filter($link.data("filter-link"),this.isActiveSidebar());if(!filterType){return;}
if($link.find("div").length){this.callGaEvent(filterType,$link.find("div").attr("option-label"));}else{this.callGaEvent(filterType,$link.html());}
refinementGA4({filterType,filterItemValue:filterItemTextValue||filterItemValue,});},update:function(ev,response){var $layer=$(this.layer),layerHtml=$(response.layer).html();$layer.html(layerHtml);this._applyBindings($layer);},changePrice:function(ev,values){var url=this.getPriceUrl(values);const priceValues=values.join("-");this.callGaEvent("price",priceValues);refinementGA4({filterType:'price',filterItemValue:priceValues,})
layerAction.filter(url,this.isActiveSidebar());},getPriceUrl:function(values){var location=window.location,params=location.search!==""?$.parseQuery(location.search):{};delete params.p;params.price=values.join("-");params=$.param(params);return location.origin+location.pathname+"?"+params;},initSticky:function(){var $layer=$(this.layer),padding=parseInt($layer.css("padding-top"));$(this.sidebar).theiaStickySidebar({additionalMarginTop:80-padding});},recalcSticky:function(){this.sidebarParams=null;this.initSticky();},openSidebar:function(){window.$isOpenFilters=true;$(this.settings.toggleButton).addClass("_active");$html.addClass(this.settings.classSidebarOpen);$(this.sidebar).slideDown();document.body.classList.add('show_close_filter_btn');},closeSidebar(){window.$isOpenFilters=false;$(this.settings.toggleButton).removeClass("_active");$html.removeClass(this.settings.classSidebarOpen);$(this.sidebar).slideUp();document.body.classList.remove('show_close_filter_btn');},toggleSidebar:function(){window.$isOpenFilters?this.closeSidebar():this.openSidebar();},isActiveSidebar:function(){return $(this.settings.toggleButton).hasClass("_active");},preventDefault:function(settings,ev){ev.preventDefault();},initAccordion:function(){$(this.layer).on("click",this.accordion.title,function(ev){ev.preventDefault();var $title=$(ev.currentTarget),$block=$title.closest(this.accordion.block);this.sidebarParams=this.getSidebarParams();if($block.hasClass(this.settings.classActive)){this.accordionUp($block,$title);}else{this.accordionDown($block,$title);}}.bind(this));},accordionUp:function($block,$title){$title.removeClass(this.settings.classExpand);$block.find(this.accordion.content).hide();$block.removeClass(this.settings.classActive);this.checkSticky();},accordionDown:function($block,$title){$title.addClass(this.settings.classExpand);$block.find(this.accordion.content).show();$block.addClass(this.settings.classActive);this.checkSticky();},checkSticky:function(){var $sticky=$(this.sidebar).find(".theiaStickySidebar"),$main=$(".column.main"),heightSticky=$sticky.outerHeight(),bottomSticky=$sticky.offset().top+heightSticky,bottomMain=$main.offset().top+$main.height(),scroll,delta;scroll=$(document).scrollTop()+$(window).height();delta=Math.abs(bottomSticky-bottomMain);if(delta>10&&(bottomSticky<=scroll||scroll>bottomMain)){this.initSticky();}},getSidebarParams:function(){var $sticky=$(this.sidebar).find(".theiaStickySidebar");return{height:$sticky.outerHeight(),position:$sticky.css("position"),top:parseInt($sticky.css("transform").split(",")[5])||0};},_applyBindings:function($container){var $els=$container.find("[data-bind^=\"scope\"]");if($.fn.applyBindings!==undefined){$els.each(function(i,el){ko.cleanNode(el);$(el).trigger("contentUpdated").applyBindings();});}},callGaEvent:function(filterName,filterValue){if(typeof filterName=="undefined"||typeof filterValue=="undefined")return;filterValue=filterValue.trim();var dataLayer=window.dataLayer||[];dataLayer.push({event:"nievent",eventCategory:"Filters",eventAction:filterName,eventLabel:filterValue});if(filterName&&filterValue){refinementSelected({filterName,filterValue});}}});});