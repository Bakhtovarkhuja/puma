define(["esEvent","generateGuid",],function(esEvent,generateGuid){return{init(data,isNewCartStatus=false){this.localStorageGuidHash="eSputnikGuid";this.localStorageUserCurrentCartStatus="eSputnikUserCurrentCartStatus";this.localStorageUserLastCartStatus="eSputnikUserLastCartStatus";this.getCardDataUrl="/customer/section/load/?sections=cart";this.isNewCartStatus=isNewCartStatus;if(typeof data==="object"){this.sendEvent(data);}else{this.getCartData(this.getCardDataUrl);}},getCartData(url){fetch(url).then(response=>{return response.json();}).then(data=>{this.sendEvent(data.cart);return data.cart;}).catch(error=>{console.error("er",error);});},sendEvent(data){if(!data){console.error("No data passed generateEventBody StatusCart event: ",data);return;}
const productItems=[];if(data.items&&Array.isArray(data.items)&&data.items.length){data.items.forEach(item=>{const productItemObj={productKey:item.product_sku,price:''+item.product_price_value,quantity:item.qty,};productItems.push(productItemObj);});}
const eventBody=this.generateEventBody(productItems,this.getGuid(this.isNewCartStatus,productItems));window.localStorage.setItem(this.localStorageUserCurrentCartStatus,JSON.stringify(eventBody));esEvent("StatusCart",eventBody);},generateEventBody(productItems,GUID){return{"StatusCart":productItems,"GUID":GUID};},saveLastCartStatus(productItems,GUID){const currentUserState=window.localStorage.getItem(this.localStorageUserCurrentCartStatus);if(currentUserState){window.localStorage.setItem(this.localStorageUserLastCartStatus,currentUserState);}else{const eventBody=this.generateEventBody(productItems,GUID,);window.localStorage.setItem(this.localStorageUserLastCartStatus,JSON.stringify(eventBody));}},getGuid(isNewCartStatusVar,productItems){let guidVar=window.localStorage.getItem(this.localStorageGuidHash);if(isNewCartStatusVar||!guidVar){guidVar=generateGuid();this.saveLastCartStatus(productItems,guidVar);window.localStorage.setItem(this.localStorageGuidHash,guidVar);}
return guidVar;},};});