define(['jquery','ko','uiComponent','matchSize','jquery-ui-modules/slider','jquery/jquery.parsequery','touchPunch','browser'],function($,ko,Component,matchSize){'use strict'
var isChanged=false,$html=$('html')
ko.bindingHandlers.slider={init:function(element,valueAccessor,allBindingsAccessor,ViewModel){var options={}
var from=+ko.toJS(ViewModel.from)
var to=+ko.toJS(ViewModel.to)
var sliderValues=ko.utils.unwrapObservable(valueAccessor())
options.min=ViewModel.min
options.max=ViewModel.max
options.values=[from,to]
options.range=true
options.slide=function(ev,ui){isChanged=true
sliderValues.from(ui.values[0])
sliderValues.to(ui.values[1])}
options.stop=function(ev,ui){if(!isChanged){return}
isChanged=false
$(document).triggerHandler('price-filter:change',[[ui.values[0],ui.values[1]]])
$(document).triggerHandler('price-filter:blur')}
ko.utils.domNodeDisposal.addDisposeCallback(element,function(){$(element).slider('destroy')})
$(element).slider(options)},update:function(element,valueAccessor){var values=ko.toJS(valueAccessor())
var from=+values.from
var to=+values.to
var current=$(element).slider('values')
if(from!==current[0]||to!==current[1]){$(element).slider('values',[from,to])}}}
function strToNum(str){if(typeof str==='number'){return str}
return Number(str.replace(/,/g,'.').replace(/\s/g,''))}
return Component.extend({initialize:function(){this._super()
this.settings={classFixed:'page-fixed'}
this.from=ko.observable(this.from)
this.to=ko.observable(this.to)
this.validate=function(data,ev){var $target=$(ev.target)
var min=this.min
var max=this.max
var from=strToNum(data.from())
var to=strToNum(data.to())
if($target.data('from')!==undefined){if(from>to){from=to}else if(from<min){from=min}
this.from(from)}else if($target.data('to')!==undefined){if(to<from){to=from}else if(to>max){to=max}
this.to(to)}
$(document).triggerHandler('price-filter:change',[[from,to]])
$(document).triggerHandler('price-filter:blur')}
$(document).on('touchmove',this.checkFixed.bind(this))
$(document).on('price-filter:blur',this.checkFixed.bind(this))},focusinInput:function(){if(!matchSize().tablet||$.browser.desktop){return}
this.sidebarParams=this.getSidebarParams()
if(this.sidebarParams.position!=='fixed'){return}
this.pageTop=$(document).scrollTop()
$html.addClass(this.settings.classFixed).css('top',-this.pageTop)},blurInput:function(){if(!matchSize().tablet||$.browser.desktop||!$html.hasClass(this.settings.classFixed)){return}
$html.removeClass(this.settings.classFixed)
if(this.pageTop){$(document).scrollTop(this.pageTop)}},checkFixed:function(){if(!matchSize().tablet||$.browser.desktop){return}
this.blurInput()
$(this.input).filter(':focus').blur()},getSidebarParams:function(){var $sticky=$('.sidebar-main').find('.theiaStickySidebar')
return{height:$sticky.outerHeight(),position:$sticky.css('position'),top:parseInt($sticky.css('transform').split(',')[5])||0}},rendered:function(min,max){if(!this.isFilteredByPrice()){this.min=min
this.max=max
this.from(min)
this.to(max)
return}
if(this.from()<min){this.from(min)}
if(this.to()>max){this.to(max)}},isFilteredByPrice:function(){var location=window.location,params=location.search!==''?$.parseQuery(location.search):{}
return params.price!==undefined}})})