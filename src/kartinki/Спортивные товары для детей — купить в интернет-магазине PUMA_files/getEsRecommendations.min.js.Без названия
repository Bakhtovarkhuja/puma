define(['generateGuid',],function(generateGuid,){return function(options={}){window.$getCookie=function(name){const match=document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)'));if(match)return match[2];}
const{blockId=24351,products=[],urlWithContentId="24351_r1077v1448",requestParams={}}=options;function getProductsStrArr(arr){return arr.length?`products: ["${ arr.join('","') }"],`:"";}
function getCategoryId(){const categoryId=requestParams?.categoryId||window?.analyticsPageData?.category?.category?.google_category;return categoryId?`category: "${ categoryId }",`:"";}
let userSessionUUID=null;userSessionUUID=window.$getCookie('sc');if(!userSessionUUID){userSessionUUID=generateSessionUserUUID();}
function generateSessionUserUUID(){const RECOMMENDATION_USER_KEY='recommendation_user_session_key';let userSessionData=JSON.parse(window.localStorage.getItem(RECOMMENDATION_USER_KEY));if(userSessionData&&userSessionData.uuid){if(window.$currentCustomer?.sessionID&&userSessionData.userSessionId&&window.$currentCustomer?.sessionID===userSessionData.userSessionId){userSessionUUID=userSessionData.uuid;}else if(window.$currentCustomer?.sessionID){if(userSessionData.userSessionId){setNewUserSessionData();}else{userSessionUUID=userSessionData.uuid;window.localStorage.setItem(RECOMMENDATION_USER_KEY,JSON.stringify({uuid:userSessionData.uuid,userSessionId:window.$currentCustomer?.sessionID||'',}));}}else{userSessionUUID=userSessionData.uuid;}}else{setNewUserSessionData();}
function setNewUserSessionData(){const userSessionData={uuid:generateGuid(),userSessionId:window.$currentCustomer?.sessionID||'',};userSessionUUID=userSessionData.uuid;window.localStorage.setItem(RECOMMENDATION_USER_KEY,JSON.stringify(userSessionData));}
return userSessionUUID;}
const graphQlQuery=`
            {
                recommendations {
                    products(
                        isV2: true,
                        blockId: ${ blockId },
                        ${ getProductsStrArr(products) }
                        ${ getCategoryId() }
                        languageCode: "${ document.documentElement.lang || "ru" }",
                        cookie: "${ userSessionUUID }",
                    ) {
                        products {
                            id
                            price
                            imageUrl
                            name
                            brand
                            category
                            categoryId
                            categoryParent
                            isInStock
                            color_article: tagAsString(tag: "item_group_id")
                            tags_discount: tagAsString(tag: "discount")
                            url: urlWithContent(id: "${ urlWithContentId }", delimiter: "?")
                            tags_old_price: tagAsString(tag: "old_price")
                            tags_oldprice: tagAsString(tag: "oldprice")
                            tags_price_range: tagAsString(tag: "price_range")
                            tags_additional_image_link: tagAsString(tag: "additional_image_link")
                            custom_label_0: tagAsString(tag: "custom_label_0")
                            custom_label_1: tagAsString(tag: "custom_label_1")
                            custom_label_2: tagAsString(tag: "custom_label_2")
                            custom_label_3: tagAsString(tag: "custom_label_3")
                            custom_label_4: tagAsString(tag: "custom_label_4")
                            custom_label_5: tagAsString(tag: "custom_label_5")
                            logged_custom_label_1: tagAsString(tag: "logged_custom_label_1")
                            logged_custom_label_2: tagAsString(tag: "logged_custom_label_2")
                            logged_custom_label_3: tagAsString(tag: "logged_custom_label_3")
                            sale_price: tagAsString(tag: "sale_price")
                            logged_sale_price: tagAsString(tag: "logged_sale_price")
                            tags_condition: tagAsString(tag: "condition")
                            tags_color: tagAsString(tag: "color")
                            tags_rate: tagAsString(tag: "rate")
                            google_id: tagAsString(tag: "id")
                            tags_is_bestseller_by_categories: tagAsString(tag: "is_bestseller_by_categories")
                            tags_novelty: tagAsString(tag: "novelty")

                        }
                        status
                    }
                }
            }
        `;return new Promise((resolve,reject)=>{fetch("https://ai.softcube.com/graphql",{method:"POST",headers:{"Content-Type":"application/json",},xhrFields:{withCredentials:true},crossDomain:true,body:JSON.stringify({query:graphQlQuery}),}).then((res)=>res.json()).then(data=>{if(data&&data.data&&data.data.recommendations&&data.data.recommendations.products&&data.data.recommendations.products.products){resolve(data.data.recommendations.products.products);}}).catch(error=>{reject(error);console.error("%cError getting eSputnik recommendation: ","background: #000; color: #c30677;",error);});});};});