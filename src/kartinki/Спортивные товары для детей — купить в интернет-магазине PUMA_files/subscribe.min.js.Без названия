define(['jquery','mage/cookies','pageLoader','js/gga/ga4Custom/newsletterSubscription',],function($,mageCookies,pageLoader,newsletterSubscription,){return class SubscribeForm{constructor(form,additionalFormOptions,callBacks={successCallback:null,errorCallback:null,},options={}){if(!form){return;}
this.formEl=form;this.resetSelector="[data-form-state-reset]";this.emailEl=this.formEl.querySelector("input[type=email]");this.submitEl=this.formEl.querySelector("[type=submit]");this.confirmCheckbox=this.formEl.querySelector("[data-form-confirm-checkbox]");this.containerEl=this.formEl.closest("[data-form-container]");this.additionalFormOptions=additionalFormOptions;this.callBacks=callBacks;this.options=options;this.addListeners();}
validateForm(){const formValidator=$(this.formEl)?.validate();return new Promise(resolve=>{setTimeout(()=>{resolve(formValidator?.valid());},0);});}
addListeners(){this.formEl.addEventListener("submit",e=>{e.preventDefault();this.validateForm().then(isValidForm=>{if(!isValidForm){return;}
if(this.confirmCheckbox&&!this.confirmCheckbox.checked){this.confirmCheckbox.classList.add("invalid");return;}
this.sendForm();});});if(this.containerEl){const resetElems=this.containerEl.querySelectorAll(this.resetSelector);if(resetElems.length){resetElems.forEach(el=>{el.addEventListener("click",this.resetForm);});}}
if(this.confirmCheckbox){this.confirmCheckbox.addEventListener("change",(e)=>{this.confirmCheckbox.classList[e.currentTarget.checked?"remove":"add"]("invalid");const isValidFormFields=$(this.formEl).validation("isValid");});}}
sendForm(){if(this.submitEl){this.submitEl.disabled=true;}
const formData=new FormData(this.formEl);const baseInfo={"email":this.emailEl.value,"preferences":formData.getAll("preferences"),};const firstName=formData.get('firstName');firstName&&Object.assign(baseInfo,{firstName});const lastName=formData.get('lastName');lastName&&Object.assign(baseInfo,{lastName});const data=this.additionalFormOptions?Object.assign(baseInfo,this.additionalFormOptions):baseInfo;data.form_key=$.mage.cookies.get('form_key')||document.querySelector('input[name="form_key"]')?.value;const that=this;$.ajax({type:"POST",url:"/rest/all/V1/news/subscribe",contentType:"application/json",data:JSON.stringify(data),beforeSend:function(){pageLoader.showLoading(that.options.showLoadingOnElement?$(that.options.showLoadingOnElement):null);}}).done(function(response){if(that.callBacks&&that.callBacks.successCallback){that.callBacks.successCallback(response);}
that.resetForm();if(response?.result==='success'){newsletterSubscription({preferences:data.preferences,formType:data.formType,});}}.bind(this)).fail(function(response){if(that.callBacks&&that.callBacks.errorCallback){that.callBacks.errorCallback(response);}}.bind(this)).always(function(){pageLoader.hideLoading(that.options.showLoadingOnElement?$(that.options.showLoadingOnElement):null);});}
resetForm(){this.formEl.reset();if(this.submitEl){this.submitEl.disabled=false;}
this.removeValidationClass('_fill',this.formEl);this.removeValidationClass('valid',this.formEl);this.removeValidationClass('invalid',this.confirmCheckbox);}
removeValidationClass(className,parentElem){if(!parentElem){return;}
const elems=parentElem.querySelectorAll(className);elems.forEach(elem=>{elem.classList.remove(className);});}};});