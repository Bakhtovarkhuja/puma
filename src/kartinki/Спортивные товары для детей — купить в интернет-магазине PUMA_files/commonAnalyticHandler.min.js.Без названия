define(["jquery","Magento_Customer/js/customer-data","statusCartEvent","searchRequestEvent","gga.event.pV","gga.event.viewCart","gga.event.addToCart","gga.event.removeFromCart","gga.event.viewPromotion","gga.event.selectPromotion","helper.onLoadedPageWIthAnalytics","isNewStatusState",'js/helper/isElementInViewport','js/gga/ga4CustomEvent','js/helper/globalConfig','js/lib/md5.min','js/wishlist/getWishList',],function($,customerData,statusCartEvent,searchRequestEvent,pageViewGtmEvent,viewCartGtmEvent,addToCart,removeFromCart,viewPromotion,selectPromotion,onLoadedPageWIthAnalytics,isNewStatusState,isElementInViewport,ga4CustomEvent,globalConfig,md5,getWishList,){const mageCache=JSON.parse(window.localStorage.getItem("mage-cache-storage"));const updateCartPromise=new Promise(resolve=>{if(mageCache&&mageCache.cart&&Object.keys(mageCache.cart).length){window.$analyticsPageData=Object.assign({},window.$analyticsPageData,{cart:mageCache.cart});resolve(mageCache.cart);}
customerData.get("cart").subscribe(function(cart){if(!cart||!Array.isArray(cart.items)){return;}
const cartStatusKeyArray=[];cart.items.forEach(item=>{cartStatusKeyArray.push(`${ item.product_sku }:${ item.qty }`);});const isNewCartStatus=isNewStatusState(cartStatusKeyArray.join(),"eSputnikGuidKey");if(!isNewCartStatus){return;}
window.$analyticsPageData=Object.assign({},window.$analyticsPageData,{cart});window.$customerCart=cart;const customEvent=new CustomEvent("cart.update",{detail:cart,});window.document.dispatchEvent(customEvent);resolve(cart);statusCartEvent.init(cart,isNewCartStatus);});});const updatePageDataPromise=new Promise(resolve=>{window.document.addEventListener("pageData.update",event=>{resolve(event.detail);});});const updateCustomerPromise=new Promise(resolve=>{if(mageCache&&mageCache.customer&&Object.keys(mageCache.customer).length){window.$analyticsPageData=Object.assign({},window.$analyticsPageData,{customer:mageCache.customer});resolve(mageCache.customer);}
window.$currentCustomer=window.customer;if(window.$currentCustomer?.id){getWishList(window.$currentCustomer?.id);}
customerData.get("customer").subscribe((customer)=>{window.$analyticsPageData=Object.assign({},window.$analyticsPageData,{customer});setUserInfo(customer);window.document.dispatchEvent(new CustomEvent("customer.update",{detail:customer,}));});});function setUserInfo(customer){window.$currentCustomer=customer;if(customer.email){window.localStorage.setItem('$storageKeyAuthCustomer',JSON.stringify(customer));}
document.body.dispatchEvent(new CustomEvent("customer.update",{detail:customer}));}
const loadPromise=new Promise(resolve=>{function loadPageEventHandler(event){resolve(event);setHeaderCartEvents();}
if(document.readyState==="complete"){loadPageEventHandler(document.readyState);}else{window.addEventListener("load",(event)=>{loadPageEventHandler(event);});}});const setHeaderCartEvents=()=>{const $pumaHeader=document.querySelector("puma-header");if($pumaHeader&&$pumaHeader.shadowRoot){const $cartLink=$pumaHeader.shadowRoot.querySelector("puma-container a[href='#cart']");if($cartLink){$cartLink.addEventListener("click",e=>{statusCartEvent.init();viewCartGtmEvent({cartData:window.$analyticsPageData.cart,pageDataCard:window.pageData.cart,});});}}};const loadPageUpdatedStatsEvent=new CustomEvent("load.cart.customer");Promise.all([loadPromise,updateCartPromise,updateCustomerPromise,]).then(values=>{function loadCustomerDataHandler(){const page_type=window.pageCategory||"plp";function getIndexStatus(statusString){if(statusString&&new RegExp('NOFOLLOW','gim').test(statusString)){return'noindex';}
return'index';}
pageViewGtmEvent({cartData:window.$analyticsPageData.cart,pageDataCard:window.pageData.cart,customerData:window.$analyticsPageData.customer,});ga4CustomEvent('GA4generic',{page_type,page_title:document.title,page_path:window.location.pathname,page_location:window.location.href,query_string:window.location.search.substring(1),local_language:document.documentElement.getAttribute("lang"),custom_user_id:window.$analyticsPageData?.customer?.id||'',store_view:globalConfig.locale,is_guest:String(!window.isLoggedIn),release_version:window.pageData?.navigation?.releaseVersion||"2.0.0",gsm_code:'+380',index_status:getIndexStatus(document.querySelector('meta[name="robots"]')?.content),hashed_email:md5(window.$analyticsPageData?.customer?.email||'',),referrer:document.referrer,});window.$loadedCartCustomer=true;window.document.dispatchEvent(loadPageUpdatedStatsEvent);}
setTimeout(()=>{if(window.pageData&&window.pageData&&Object.keys(window.pageData).length){loadCustomerDataHandler();}else{updatePageDataPromise.then(event=>{loadCustomerDataHandler();});}},300);});window.document.addEventListener("cart.add",e=>{if(window.analyticsPageData&&window.analyticsPageData.product){addToCart({analyticsDataProduct:window.analyticsPageData.product,formDataInfo:e.detail,});}
if(window.esk){console.log('%cEskimi%c track Conversion sent',"background: #ffffff; color: #43e500;","background: #000; color: #c30677;");esk('track','Conversion');}else{console.error('Could not load Eskimi track Conversion',esk);}});window.document.addEventListener("cart.remove",e=>{if(e.detail&&e.detail.products?.length){removeFromCart(e.detail.products,e.detail.price);}});onLoadedPageWIthAnalytics(()=>{selectPromotion();viewPromotion();});(()=>{const wm=new WeakMap();document.querySelectorAll('video').forEach(el=>{el.addEventListener("play",mediaHandlerPlay);el.addEventListener("ended",mediaHandlerEnded);el.addEventListener("timeupdate",mediaHandlerTimeUpdate);});function mediaHandlerPlay(event){const videoEl=event.target;ga4CustomEvent('video_start',{video_current_time:String(videoEl.currentTime),video_duration:String(videoEl.duration),video_percent:videoEl.currentTime?String(Math.round(videoEl.currentTime / videoEl.duration*100)):'0',video_provider:'media',video_title:String(videoEl.title),video_url:String(videoEl.src),visible:String(isElementInViewport(videoEl)),});}
function mediaHandlerEnded(event){const videoEl=event.target;ga4CustomEvent('video_complete',{video_current_time:String(videoEl.currentTime),video_duration:String(videoEl.duration),video_percent:videoEl.currentTime?String(Math.round(videoEl.currentTime / videoEl.duration*100)):'0',video_provider:'media',video_title:String(videoEl.title),video_url:String(videoEl.src),visible:String(isElementInViewport(videoEl)),});wm.delete(this);}
function mediaHandlerTimeUpdate(event){let videoState=null;if(wm.has(this)){videoState=wm.get(this);}else{videoState=new Map();videoState.set(10,false);videoState.set(25,false);videoState.set(50,false);videoState.set(75,false);wm.set(this,videoState);}
triggeringProgressEvent(this,videoState);}
function triggeringProgressEvent(videoEl,videoState){const withinValue=5;const currentPercent=videoEl.currentTime?String(Math.round(videoEl.currentTime / videoEl.duration*100)):0;if(!currentPercent){return;}
for(const[key,value]of videoState.entries()){if(!value&&currentPercent>=key-withinValue&&currentPercent<=key+withinValue){videoState.set(key,true);ga4CustomEvent('video_progress',{video_current_time:String(videoEl.currentTime),video_duration:String(videoEl.duration),video_percent:String(currentPercent),video_provider:'media',video_title:String(videoEl.title),video_url:String(videoEl.src),visible:String(isElementInViewport(videoEl)),});break;}}}})();});