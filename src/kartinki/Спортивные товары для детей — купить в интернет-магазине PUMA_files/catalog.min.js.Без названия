define(["uiComponent","ko","jquery","uiRegistry","matchSize","js/scroll-to-block","gga.event.viewItemList","helper.onLoadedPageWIthAnalytics","gga.setCatalogProductsClickHandler","debounce",],function(Component,ko,$,registry,matchSize,scrollToBlock,viewItemList,onLoadedPageWIthAnalytics,setCatalogProductsClickHandler,debounce,){"use strict";var $document=$(document),$body=$("body");onLoadedPageWIthAnalytics(()=>{setCatalogProductsClickHandler();if(window.analyticsPageData&&window.analyticsPageData.category&&window.analyticsPageData.category.products&&typeof window.analyticsPageData.category.products==="object"&&Object.keys(window.analyticsPageData.category.products).length){viewItemList({products:window.analyticsPageData.category.products});}
$document.on("catalog:update",(e)=>{if(window.analyticsPageData&&window.analyticsPageData.category&&window.analyticsPageData.category.products&&typeof window.analyticsPageData.category.products==="object"&&Object.keys(window.analyticsPageData.category.products).length){viewItemList({products:window.analyticsPageData.category.products});}});});return Component.extend({defaults:{afterUpdate:{},tracks:{afterUpdate:true}},filterSelector:".toolbar-filter-link .category-select",initialize:function(){this._super();this.settings={bindNodeSelector:"[data-bind^=\"scope\"]"};this.events();},events:function(){$document.on("catalog:update",this.update.bind(this));$document.on("catalog:appendProducts",this.appendProducts.bind(this));$document.on("sorter:initialized",this.moveBlocks.bind(this));$(window).on("resize.catalog",this.moveBlocks.bind(this));window.addEventListener("resize",debounce(this.moveBlocks.bind(this),300));},update:function(ev,data){var contentHtml=$(data.content).html(),$catalog=$(this.catalog),$title=$(this.title),$seo=$(this.seo),$toolbar=$(this.toolbar),filterClass=$toolbar.find(this.filterSelector).attr("class"),$breadcrumbs=$("#breadcrumbs-block");$toolbar.remove();$catalog.html(contentHtml);$catalog.find(this.filterSelector).attr("class",filterClass);$title.replaceWith(data.header);$seo.replaceWith(data["category-seo"]);if(data["breadcrumbs"]){$breadcrumbs.replaceWith(data["breadcrumbs"]);}
if(data.isActive){$document.triggerHandler("layer:openSidebar");}
this._applyBindings($catalog);this.moveBlocks();this.updateStickySidebar();this.scrollToGrid($catalog);this.afterUpdate=data;},appendProducts:function(ev,data){var gridHtml=$(data.content).find(this.grid).html(),pagerHtml=$(data.content).find(this.pager).html(),$grid=$(this.catalog).find(this.grid),$pager=$(this.catalog).find(this.pager),$title=$(this.title);$grid.append(gridHtml);$pager.html(pagerHtml);$title.replaceWith(data.header);this._applyBindings($pager.parent());this._applyBindings($grid);this.updateStickySidebar();this.afterUpdate=data;},updateStickySidebar:function(){$document.triggerHandler("layer:stickySidebar");},moveBlocks:function(){if(matchSize().mobile){$(this.toolbar).prependTo($(this.columns));$(this.searchTitle).prependTo($(this.columns));}else{$(this.toolbar).prependTo($(this.catalog));$(this.searchResults).before($(this.searchTitle));}},scrollToGrid:function($el){var currentH=$el.height(),offset=$el.offset().top+currentH;if($document.scrollTop()<=offset){return;}
scrollToBlock({block:$body});},_applyBindings:function($container){var $els=$container.find("[data-bind^=\"scope\"]");if($.fn.applyBindings!==undefined){$els.each(function(i,el){ko.cleanNode(el);$(el).trigger("contentUpdated").applyBindings();});}}});});